Super ugly code. It probably won't get any better.
